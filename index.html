<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<html lang="fa">
<head>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge">
	<meta charset="UTF-8">
  <script src="js/ckeditor/ckeditor.js"></script>

  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="css/bootstrap.min.css">

  <!-- Optional theme -->
  <link rel="stylesheet" href="css/bootstrap-theme.min.css">
  
  <link rel="stylesheet" href="css/amaran.min.css">    
  <link rel="stylesheet" href="css/animate.min.css">
  <link rel="stylesheet" href="css/loader.css">
  <link rel="stylesheet" href="css/sticky-footer.css">
  
  <script src="js/modernizr.min.js"></script>
</head>

<body id="bodyElement">
<!--[if lt IE 7]>
<p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
<![endif]-->

	<header id="entry-header" class="entry-header">
			<h1 class="entry-title">در حال بارگزاری اطلاعات ...</h1>
		</header>

		<div id="loader-wrapper">
			<div id="loader"></div>

			<div class="loader-section section-left"></div>
      <div class="loader-section section-right"></div>

		</div>

<div class="jumbotron">
    <h3 class="display-3" name="requestTitle"></h3>
    <p class="lead" name="requestBody"></p>
    
    
<div id="messages">
    
</div>
    
    <select id="ChangeState" name="ChangeState" onchange="updateRequest();">
        <option value="0">Select</option>
        <option value="1">DabirKhani</option>
        <option value="2">Dabir with edit</option>
        <option value="3">Komisiion</option>
        <option value="4">Commission With Edit</option>
        <option value="5">Unaccepted</option>
        <option value="6">Late</option>
        <option value="7">Exit</option>
    </select>

	<input type="file" id="fileSelector" multiple size="24">
    <hr class="my-4">
    <p data-bind="">
        <textarea id="ChangedBody" name="ChangedBody"></textarea>
    </p>
    <input type="hidden" id="requestId" name="requestId"/>
</div>

<div class="container center">
    <div class="btn-group" role="group" aria-label="Basic example">
    </div>
</div>



<footer class="footer">
  <div class="container">
  	
		<div id="syncer-wrapper">
			<div id="syncer"></div>
			<div id="synced"></div>
			<div id="ready"></div>
		</div>
  
    <span class="text-muted"></span>
  </div>
</footer>

<script src="js/jquery.min.js"></script>
<script src="/js/jquery.amaran.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/indexeddbmanager.js?2"></script>
<script src="js/loader.js"></script>
<script>
  CKEDITOR.editorConfig = function (config) {
        config.toolbar = [
            { name: 'basicstyles', items: ['Bold', 'Italic', 'Underline', 'Strike', 'Subscript', 'Superscript', '-', 'RemoveFormat'] },
        ];
    };

    CKEDITOR.replace('ChangedBody');

    (function() {
        var pluginName = 'autosave';

        var timeOutId = 0,
            delay = 2, // in seconds || CKEDITOR.config.autosave_delay
            ajaxActive = false;

        var startTimer = function(event) {
            if(timeOutId) {
                clearTimeout(timeOutId);
            }
            timeOutId = setTimeout(onTimer, delay*1000, event);
        }

        var onTimer = function (event) {
            if(ajaxActive) {
                startTimer(event);
                ajaxActive = false;
            }
            else {
                ajaxActive = true;
                updateRequest();
                $.amaran({'message':'auto save working...'});
            }
        }

        CKEDITOR.plugins.add( pluginName, {
            init : function( editor ) {
                editor.on('key', startTimer);
            }
        });
    })();

    function getFromDB() {
        var id = 1220
        read(id)
    }

    function getData(data) {
        $('[name="title"]').html(data.Title);
        for (var i = 1; i <= data.RequestResults.length; i++) {
            $('div[class="btn-group"').append('<button type="button" class="btn btn-light" onclick="getRequest(' + data.RequestResults[i-1].Id + ');">' + i + '</button>')
        }
			getRequest(data.RequestResults[0].Id); 
      endLoader();
    }

    function getRequest(id) {
        updateRequest();
        requestRead(id);
    }

    function setRequest(data) {
        $('[name="requestTitle"]').html(data.Id + ". " + data.Title);
        $('[name="requestBody"]').html(data.RequestBody);
        $('[name="requestId"]').val(data.Id);
        $('[name="ChangedBody"]').html(data.TrusteeBody)
        $('[name="ChangeState"]').val(data.ChangeState)
        CKEDITOR.instances['ChangedBody'].setData(data.ChangedBody);
    }

    function updateRequest() {
	    doSaveDb();
        if ($('[name="requestId"]').val() !== '') {
            var request = {
            	
                Id: parseInt($('[name="requestId"]').val()),
                Title: $('[name="requestTitle"]').html(),
                ChangedBody: CKEDITOR.instances['ChangedBody'].getData(),
                RequestBody: $('[name="requestBody"]').html(),
                ChangeState: $('[name="ChangeState"]').val()
            }

            requestPut(request);
        }
    }

    function postData() {
        $('[name="postData"]').addClass("hide");
        $('[name="resultMessage"]').addClass("hide");
        readSessionForPost(1220);
    }

    function sendSessionInfoToServer(session) {
    	doPost();
        $.ajax({
            url: 'http://92.50.13.16:6073/api/sessions/',
            type: 'POST',
            dataType: 'json',
            data: session,
            success: function (data, textStatus, xhr) {
                $('[name="postData"]').removeClass("hide");
                $('[name="resultMessage"]').removeClass("hide");

                $('[name="resultMessage"]').html('اطلاعات به سرور ارسال شد!');
                $.amaran({'message':'اطلاعات به سرور ارسال شد!'});
                doSynced();
            },
            error: function (xhr, textStatus, errorThrown) {
	            doReady();
                console.log('Error in send info');
            }
        });
    }
  function doSync() {
  console.log('doSync')
  	$('[id="syncer"]').css('display', 'block');
  	$('[id="synced"]').css('display', 'none');
  	$('[id="ready"]').css('display', 'none');
  }
  
  function doReady() {
  console.log('doReady')
  	$('[id="syncer"]').css('display', 'none');
  	$('[id="synced"]').css('display', 'none');
  	$('[id="ready"]').css('display', 'block');
  }
  
  function doSynced() {
  console.log('doSynced')
  	$('[id="syncer"]').css('display', 'none');
  	$('[id="synced"]').css('display', 'block');
  	$('[id="ready"]').css('display', 'none');
  }
  
  function doSaveDb() {
  	$('[class="text-muted"]').innerHTML = "در حال ذخیره سازی اطلاعات";
  	doSynced();
  }
  
  function doPost() {
	  $('[class="text-muted"]').innerHTML = "در حال ذخیره سازی در بانک اصلی";
	  doSynced();
  }
  
  function doNotSaveDb() {
	  $('[class="text-muted"]').innerHTML = "ذخیره سازی ناموفق در بانک اطلاعات";
	  doReady();
  }
</script>

</body>
</html>
